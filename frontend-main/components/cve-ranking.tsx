// frontend-main/components/cve-ranking.tsx
"use client"

import { useEffect, useState } from "react"
import { apiGet } from "@/lib/api"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Trophy, Info } from "lucide-react"
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip"
import Link from "next/link"

type RankingItem = { rank: number; cveId: string; cvss: number; epss: number; kve: number; activity: number }
type RankingsResponse = { items: RankingItem[] }

type GaugeProps = { label: string; value: number; max?: number }
const MetricGauge = ({ label, value, max = 10 }: GaugeProps) => {
  const percentage = Math.max(0, Math.min(100, (value / max) * 100))
  return (
    <div className="space-y-1">
      <div className="flex justify-between items-center">
        <span className="text-xs font-medium text-muted-foreground">{label}</span>
        <span className="text-xs font-semibold text-foreground">{value.toFixed(1)}</span>
      </div>
      <div className="w-full h-1.5 bg-secondary rounded-full overflow-hidden">
        <div
          className="h-full bg-gradient-to-r from-primary to-primary/70 rounded-full"
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  )
}

export function CVERanking() {
  const [items, setItems] = useState<RankingItem[]>([])

  useEffect(() => {
    let active = true
    apiGet<RankingsResponse>("/api/v1/home/rankings?limit=5&window=7d")
      .then((r) => { if (active) setItems(r.items ?? []) })
      .catch(() => { if (active) setItems([]) })
    return () => { active = false }
  }, [])

  return (
    <Card className="border-border h-fit bg-card">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-foreground">
          <Trophy className="h-5 w-5 text-primary" />
          CVE 랭킹
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        {items.map((item) => (
          <Link
            key={item.rank}
            href={`/cve/${item.cveId}`}
            className="flex items-start gap-4 p-3 rounded-lg bg-secondary/50 hover:bg-secondary transition-colors cursor-pointer"
          >
            <div className="text-3xl font-bold text-primary/60 w-12 text-center flex-shrink-0">{item.rank}</div>
            <div className="flex-1 space-y-2">
              <p className="font-semibold text-foreground hover:text-primary transition-colors text-lg">{item.cveId}</p>
              <div className="space-y-1.5 pt-1">
                <MetricGauge label="CVSS" value={item.cvss} />
                <MetricGauge label="EPSS" value={item.epss} />
                <MetricGauge label="KVE" value={item.kve} />
                <MetricGauge label="활동도" value={item.activity} />
              </div>
            </div>
          </Link>
        ))}

        {items.length === 0 && (
          <div className="text-sm text-muted-foreground">표시할 랭킹이 없습니다.</div>
        )}

        <div className="pt-4 border-t border-border">
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <div className="flex items-center gap-2 text-sm text-muted-foreground cursor-help">
                  <Info className="h-4 w-4" />
                  <span>랭킹 기준</span>
                </div>
              </TooltipTrigger>
              <TooltipContent className="max-w-xs">
                <p className="text-sm leading-relaxed">
                  <strong>CVSS:</strong> 취약점 심각도 | <strong>EPSS:</strong> 악용 예측도 | <strong>KVE:</strong> 내부 노출도 | <strong>활동도:</strong> 최근 활동 빈도
                </p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        </div>
      </CardContent>
    </Card>
  )
}
